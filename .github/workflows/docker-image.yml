name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Find and build container images
      run: |
        find . -type f -name 'Containerfile' | while read -r cfile; do
          # Get the directory containing the Containerfile (e.g., './my/app')
          CONTEXT_DIR=$(dirname "$cfile")
          
          # Create a descriptive image name from the path (e.g., 'my-app')
          # This replaces './' with nothing and '/' with '-'
          IMAGE_NAME=$(echo "$CONTEXT_DIR" | sed 's|^\./||; s|/|-|g')
          
          # Handle the case where Containerfile is in the root directory
          if [ "$IMAGE_NAME" == "." ]; then
            IMAGE_NAME="root"
          fi
          
          # Create a unique tag, e.g., "my-image-name-my-app:1678886400"
          IMAGE_TAG="my-image-name-$IMAGE_NAME:$(date +%s)"
          
          echo "=========================================================="
          echo "Building Containerfile: $cfile"
          echo "Build Context:        $CONTEXT_DIR"
          echo "Image Tag:            $IMAGE_TAG"
          echo "=========================================================="
          
          # Run the build
          docker build "$CONTEXT_DIR" --file "$cfile" --tag "$IMAGE_TAG"
        done
