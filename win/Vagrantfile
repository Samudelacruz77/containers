# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Ensure the vagrant-sshfs plugin is present (Containerfile installs it already)
  config.vagrant.plugins = ["vagrant-libvirt", "winrm", "winrm-elevated", "vagrant-vbguest"]
  # WinRM reliability/tuning
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"
  config.winrm.transport = :negotiate
  config.winrm.basic_auth_only = false
  config.winrm.retry_limit = 30
  config.winrm.retry_delay = 10
  config.winrm.timeout = 600
  # Disable default synced folder to avoid NFS on Windows guests
  config.vm.synced_folder ".", "/vagrant", disabled: true
  config.vm.define "win11", primary: true do |win11|
    win11.vm.box = "oopsme/windows11-22h2"
    win11.vm.box_version = "11-22h2-uefi"
    win11.vm.hostname = "win11"
    win11.vm.synced_folder "/home/user", "C:\\Users\\Vagrant",
      type: "rsync",
      rsync__exclude: [
        "AppData/**",
        "NTUSER.DAT*",
        "ntuser.dat*",
        "UsrClass.dat*",
        "NTUSER.*",
        "Recent/**",
        "Temp/**"
      ]
    # Enable RDP inside the guest
    win11.vm.guest = :windows
#    win11.vm.provision "shell",
#     path: "scripts/enable-rdp.ps1",
#     powershell_elevated_interactive: true
  end


  # Install flightctl inside the Windows guest
  #config.vm.provision "shell",
  #  path: "scripts/install-flightctl.ps1",
  #  powershell_elevated_interactive: true

  require 'fileutils'

  config.vm.provider :libvirt do |libvirt|
    libvirt.cpus = 4
    libvirt.memory = 16384
    # Configure UEFI firmware (OVMF). Copy VARS template to a writable path.
    libvirt.machine_type = "q35"
    loader_candidates = [
      "/usr/share/edk2/ovmf/OVMF_CODE.secboot.fd",
      "/usr/share/edk2/ovmf/OVMF_CODE.fd",
      "/usr/share/edk2/ovmf/x64/OVMF_CODE.fd",
      "/usr/share/OVMF/OVMF_CODE.fd",
      "/usr/share/ovmf/OVMF.fd"
    ]
    loader_path = loader_candidates.find { |p| File.exist?(p) }
    libvirt.loader = loader_path if loader_path
    # Use writable NVRAM under libvirt's directory (prepared by startup.sh)
    nvram_path = "/var/lib/libvirt/qemu/nvram/win_uefi_vars.fd"
    libvirt.nvram = nvram_path if File.exist?(nvram_path)
    # SPICE graphics configuration (use remote-viewer to connect)
    libvirt.graphics_type = "spice"
    libvirt.graphics_autoport = false
    libvirt.graphics_port = (ENV['SPICE_PORT'] || 5930).to_i
    libvirt.graphics_ip = ENV.fetch('SPICE_LISTEN', '127.0.0.1')
    # Video device for SPICE
    libvirt.video_type = ENV.fetch('VIDEO_TYPE', 'qxl')
  end
end

